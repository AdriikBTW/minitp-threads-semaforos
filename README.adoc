= MiniTP SOR: Threads y Semáforos
Romero Adrián Agustín; Franco Román Pachao; Nahuel Carrizo; Lucas Rodríguez
v1, {docdate}, COM-02. Docentes Andres Rojas Paredes; Leandro Dikenstein Hidalgo
:title-page:
:title-logo-image: image:ungs.png[]
:toc:
:toc-title: Índice
:source-highlighter: coderay

== Pseudocódigo

=== main

[source]
----
Inicio el semáforo mutex_comandante
Inicio el semáforo naves_en_posicion
Inicio el semáforo orden_ataque
Inicio el semáforo ciudades_caidas
Inicio el semáforo sincronizacion_batalla

Declaro los threads presidentes_threads;
Declaro los threads naves_destructoras_threads;
Declaro los threads ciudades_threads;
Declaro el thread comandante_thread;

Por las N cantidad de presidentes:
        Inicio los threads presidentes_threads con la función presidente

Por las N cantidad de naves:
        Inicio los threads naves_destructoras_threads con la función naves_destructoras

Por las N cantidad de ciudades:
        Inicio los threads ciudades_threads con la función ciudades

Inicio el thread comandante_thread con la función comandante

Por las N cantidad de presidentes:
        Espero y finalizo los threads presidentes_threads

Por las N cantidad de naves:
        Espero y finalizo los threads naves_destructoras_threads

Por las N cantidad de ciudades:
        Espero y finalizo los threads ciudades_threads

Espero y finalizo el thread comandante_thread

Destruyo el semáforo mutex_comandante
Destruyo el semáforo naves_en_posicion
Destruyo el semáforo orden_ataque
Destruyo el semáforo ciudades_caidas
Destruyo el semáforo sincronizacion_batalla
----

<<<

=== presidentes

[source]
----
Bloquear semáforo mutex_comandante para que un presidente hable con comandante

Ejecutar hablarConComandanteExtraterrestre
Ejecutar presentarseALideresMundiales

Liberar semáforo mutex_comandante para que el siguiente presidente hable
----

=== naves_destructoras

[source]
----
Ejecutar tomarPosicionEnMegaCiudad
Incrementar semáforo naves_en_posicion avisando que la nave está en posición

Esperar semáforo orden_ataque para empezar el ataque
Ejecutar atacarMegaciudad
Incrementar sincronizacion_batalla para avisar que el ataque a la ciudad terminó
----

=== ciudades

[source]
----
Esperar semáforo sincronizacion_batalla para empezar a defenderse

Ejecutar iniciarProtocoloDefensivo
Ejecutar contraatacarNaves

Incrementar semáforo ciudades_caidas avisando que la ciudad fue derrotada
----

=== comandante

[source]
----
Por las N cantidad de naves:
        Decremento el semáforo naves_en_posicion para empezar el ataque

Por las N cantidad de naves:
        Incrementar el semáforo orden_ataque para que las naves empiecen a atacar

Por las N cantidad de ciudades:
        Espero el semáforo ciudades_caidas para saber que todas las ciudades cayeron

Ejecutar perderBatalla
Ejecutar descenderATierra
Ejecutar abrirCompuertas
Ejecutar abandonarTierra
----

=== Sincronización de semáforos

[source]
----
presidentes:
     ,---> wait(comandante)
x15  |     hablarConComandanteExtraterrestre()
     |     presentarseALideresMundiales()
     `---- post(comandante)

naves_destructoras:
        tomarPosicionEnMegaCiudad()
        post(naves_en_posicion) ----------------.
        wait(orden_ataque) <------------.       | x33
        atacarMegaciudad()              | x33   |
        post(sincronizacion_batalla) ---+-------+--------.
                                        |       |        |
comandante:                             |       |        |
        wait(naves_en_posicion) <-------+-------´        |
                                        |                |
        post(orden_ataque) -------------´                |
        wait(ciudades_caidas) <---------.                |
                                        |                |
        perderBatalla()                 |            x33 |
        descenderATierra()              |                |
        abrirCompuertas()           x33 |                |
        abandonarTierra()               |                |
                                        |                |
ciudad:                                 |                |
        wait(sincronizacion_batalla) <--+----------------´
        iniciarProtocoloDefensivo()     |
        contraatacarNaves()             |
        post(ciudades_caidas) ----------´
----

El flujo y sincronización de los hilos y semáforos es el siguiente:

Todos los hilos son ejecutados con sus funciones correspondientes.

Los hilos que representan los presidentes bloquean la sección crítica para que 
solo un hilo hable con el comandante a la vez. Cuando este finaliza, libera el 
semáforo para que el siguiente presidente pueda hablar.

Los hilos que representan las naves destructoras se posicionan en las ciudades 
correspondientes, incrementando el semáforo para avisar al comandante de que estas 
ya están en su posición. Las naves quedan en espera a que el comandante les de 
la orden de ataque para proseguir.

El hilo que representa el comandante espera que las naves totales estén en posición 
para poder seguir el flujo de ejecución. Una vez que todas las naves están en 
posición, ordena a las naves que ataquen las ciudades. +
Las naves una vez recibida la orden, continuan el flujo de ejecución y atacan las 
ciudades, y mandan la señal de que terminaron de atacar.

Los hilos que representan las ciudades esperan que la señal que han sido atacadas 
esté activa para poder empezar la ejecución y defenderse. Una vez que se defendieron 
sin éxito, envían la señal de que han caído.

El comandante espera la señal de que todas las ciudades estén caídas para continuar 
y descender a la tierra, para darse cuenta demasiado tarde que el polen de la 
tierra es un veneno letal para los alienígenas, dando lugar a su aniquilación. 
El comandante decide retirarse.

== Inanición

En el esquema de sincronización que armamos, todos los hilos dependen de la coordinación con semáforos para avanzar, lo que significa que en general no debería existir inanición porque cada wait tiene su post correspondiente. Sin embargo, sí podemos identificar escenarios hipotéticos donde, si algo se rompe o se retrasa, el sistema puede quedar “trabado” o detenido indefinidamente:

=== Presidentes y el comandante

Todos los hilos de las naves y ciudades tienen que esperar a que los presidentes terminen de hablar con el comandante. Esto implica que si un presidente tarda demasiado (imaginemos que uno de los hilos queda bloqueado mucho tiempo dentro de la función), el flujo completo se retrasa.

En este caso, los hilos de las naves quedan esperando para ponerse en posición y, en consecuencia, las ciudades tampoco avanzan porque nunca reciben la orden de ataque.

Es un ejemplo de cómo un solo hilo puede ralentizar a todo el sistema.

=== Naves en posición

El ataque debe comenzar de manera simultánea, y para eso el comandante espera a que todas las naves reporten su posición. Si una sola nave tarda mucho más que las demás en llegar, todo el ataque se demora.

Esto no es inanición en el sentido clásico (porque tarde o temprano la nave reportará), pero sí genera un cuello de botella que puede detener al resto.

=== Defensa de las ciudades

Después del ataque, cada ciudad inicia su protocolo defensivo y contraataca antes de caer. El comandante no puede descender hasta que todas las ciudades hayan sido derrotadas.

Eso significa que, si alguna ciudad tarda demasiado en ejecutar su secuencia (por ejemplo, por un retardo en el semáforo o un error en el hilo), el comandante se queda esperando.

Otra vez, el sistema entero depende de que todos los participantes cumplan su parte.

=== Errores de implementación: el caso crítico del post
Si por error se olvida un sem_post en el código, por ejemplo, el sem_post(&orden_ataque) que libera a todas las naves para comenzar el ataque, entonces los hilos que esperan ese permiso (en este caso las naves) nunca avanzan. Eso genera una situación de bloqueo permanente que se propaga:

* Las ciudades no reciben ataques -> no pueden defenderse.
* El comandante nunca recibe la señal de que las ciudades cayeron -> no desciende.
* El programa entero se paraliza.
